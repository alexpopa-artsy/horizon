<% @projects.each do |project| %>
  <div class="project">
    <div class="project_name"><%= project.name %></div>
    <% stages = project.stages.order(position: :asc) %>
    <% stages.each_cons(2) do |ahead, behind| %>
      <div class="project_stage" data-stage-name="<%= ahead.name %>"><%= ahead.name %></div>
      <%
        comparison = project.snapshot&.comparisons&.detect{|c| c.behind_stage_id == behind.id && c.ahead_stage_id == ahead.id }
      %>
      <div class="project_comparison" data-unknown="<%= comparison.nil? %>" data-released="<%= comparison&.released? %>">
        <% if comparison && !comparison.released? %>
          <ul>
            <% comparison.description.each do |line| %>
              <li><%= gravatar_from_log_line(line) %> <%= line %></li>
            <% end %>
          </ul>
        <% end %>
      </div>
    <% end %>
    <div class="project_stage" data-stage-name="<%= stages.last.name %>"><%= stages.last.name %></div>
  </div>
<% end %>
